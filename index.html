<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="sw.js"></script>
</head>
<body>
    <button onclick="addRc(1)">acc RC</button>
    <button onclick="test()">test</button>
    <script>

    const getGeolocation = ()=>{
        return new Promise ((resolve, reject)=>{
            if (navigator.onLine && "geolocation" in navigator){
                const success = geolocation=>{
                    resolve(geolocation)
                }
                const error = (geolocation)=>{
                    resolve(null)
                };
                navigator.geolocation.getCurrentPosition(success, error);
            } else (resolve(null))
        })
    }

    const getCoords = (geolocation)=>{
        if (geolocation){
            [longitude, latitude, accuracy] = [geolocation.coords.longitude, geolocation.coords.latitude, geolocation.coords.accuracy]
        } else {
            [longitude, latitude, accuracy] = [null, null, null]
        }
        return {latitude, longitude, accuracy};
    }

    const postRC= (info)=>{
        return fetch('http://127.0.0.1:3306/rc', 
                {
                    method: 'POST', 
                    body: JSON.stringify(info),
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
    }
    const storeLocally= (info)=>{
        if(!localStorage.hasOwnProperty('rcLocal')){
            localStorage.setItem('rcLocal', "[]");        
        }
        const rcLocal = JSON.parse(localStorage.rcLocal);
        if (rcLocal.indexOf(info) == -1){
            rcLocal.push(info);
            localStorage.setItem('rcLocal', JSON.stringify(rcLocal));
        }
        return rcLocal;
    }

    const addRc = (user_id)=>{
        let info = {timestamp: Date.now(), user_id};

        return getGeolocation().then(geolocation=>{
            info.coords = getCoords(geolocation);
            if (navigator.onLine){
                return postRC(info)
            } else {
                throw info; 
            }
        }).then(response=>{
            if (response.status==404 || response.body.success == false)throw response;
            else{return response}
        }).then(response=>console.log("done", response)
        ).catch(info=>{
            console.log("store rc locally ", info)
            console.log(storeLocally(info));
        })
    }
    </script>
</body>
</html>